<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPI-AMRVAC: Setting up a new problem</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MPI-AMRVAC
   &#160;<span id="projectnumber">3.1</span>
   </div>
   <div id="projectbrief">The MPI - Adaptive Mesh Refinement - Versatile Advection Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Setting up a new problem </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="user_intro"></a>
Introduction</h1>
<p>This document describes how users can create new problems. It explains how to set initial conditions, and how to perform other customizations.</p>
<h1><a class="anchor" id="user_setup"></a>
Creating a New Setup</h1>
<p>User code for a new problem should go into a file called either:</p>
<ul>
<li><code>mod_usr.t</code>, if it contains dimension-independent code (Fortran+LASY)</li>
<li><code>mod_usr.f</code>, if it contains regular Fortran code</li>
</ul>
<p>A template for this file is available in <code>src/mod_usr_template.t</code>. To create a new 1D/2D/3D setup, run one of these commands: </p><pre class="fragment">setup.pl -d=1
setup.pl -d=2
setup.pl -d=3
</pre><p> This will copy an AMRVAC makefile and specify the problem dimension in it. If no user code is found, it will ask whether you want to copy the default template. Alternatively, you can look for an existing problem (look in <code>tests/</code>) and customize its <code>mod_usr.t</code> or <code>mod_usr.f</code> file to get started. To create a normal Fortran file from <code>mod_usr.t</code>, you can type <code>make mod_usr.f</code>. Specify other user routines, for a list see <a class="el" href="mod__usr__methods_8t.html">mod_usr_methods.t</a> WARNING: If you have compiled your code in n dimension, e.g., -d=3, and want switch to another dimension with the same mod_usr.t file, e.g., -d=2, You need to remove the mod_usr.f file before make to compile because the mod_usr.f will not be updated if mod_usr.t is not changed or touched and it will remain in the n-dimension form.</p>
<h1><a class="anchor" id="user_structure"></a>
Structure of mod_usr.t</h1>
<div class="fragment"></div><!-- fragment --><h2><a class="anchor" id="user_specialbound"></a>
Special boundary</h2>
<p>When the predefined boundary types provided by MPI-AMRVAC are not sufficient , a pointed <b>usr_special_bc</b> subroutine can solve the problem. It is called for each boundary region and all variable in the boundary region <b>typeboundary_min1=8*'special'...</b> is selected.</p>
<h2><a class="anchor" id="user_specialsource"></a>
Special source</h2>
<p>There are lots of possible physical source terms for the same basic equation. Rather than writing a new physics module for each, it is simpler to define a problem dependent source term in the user module.</p>
<p>A pointed <b>usr_source</b> subroutine will be called at least once in every time step. The number of calls depends on the time integration scheme defined by <b>time_integrator</b>, the parameter <b>source_split_usr</b> and also on the number of dimensions if the parameter <b>dimsplit=T</b>.</p>
<p>In any case the subroutine should integrate <b>w</b> from time <b>qt</b> to <b>qt+qdt</b> for the variables listed in <b>iw^LIM</b> in the region <b>ixO^S</b>. The source terms should be evaluated for the <b>wCT</b> array, which corresponds to the physical time <b>qtC</b>. In case of explicit time dependence, <b>qtC</b> should be used as time. Only elements within <b>ixI^S</b> can be used from <b>wCT</b>.</p>
<p>A pointed <b>usr_get_dt</b> subroutine can limit <b>dt</b> for numerical stability if the source term requires that.</p>
<p>A pointed <b>usr_special_resistivity</b> subroutine is used for MHD to set the resistivity array <b>eta</b> when it is not constant in time and/or space.</p>
<p>A pointed <b>usr_refine_grid</b> subroutine allows to add user controlled (de)refinement, by setting the integers <em>refine,coarsen</em>. You have all info available to do this refining (grid level, physical values in <em>w</em>, coordinates in <em>x</em>, time in <em>qt</em>). Similarly, a <b>usr_var_for_errest</b> subroutine allows to compute a (local) new variable, to be stored in <em>var</em>, on which you can then base refinement as well.</p>
<h2><a class="anchor" id="user_speciallog"></a>
Special output and analysis</h2>
<p>The default log-file may be altered, for which you need to code up <br  />
 a <b>usr_print_log</b> subroutine. For parallel execution, this invariably means the use of MPI constructs, so you should copy in the default version <b>printlog_default</b> from <em>src/amrvacio/mod_input_output.t</em> and then study it, and modify accordingly. An example of this customization is given in <em>tests/rho/custom_log_file</em>.</p>
<p>A pointed <b>usr_aux_output</b> is extremely handy to compute variables from the actually computed conserved variables, that can then be visualized directly. It is only used in combination with the conversion subroutines. e.g., one may here compute current density components using the actual code discretizations for computing a curl, and then visualize those with any of the visualization tools applicable. You then also need to specify a name for each variable, in a pointed <b>usr_add_aux_names</b>.</p>
<p>A pointed <b>usr_process_grid</b> and a pointed <b>usr_process_global</b> are subroutines called in each iteration, which allow to compute auxiliary variables which happen to be non-local (like div v), and are in no way used for flux computations. As auxiliaries, they are also not advanced. This functionality was added to allow e.g. for separate particle treatments using stochastic differential equations, where the particle dynamics is only relying on local compression values. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
