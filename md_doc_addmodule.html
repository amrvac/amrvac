<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPI-AMRVAC: Adding a physics module to MPI-AMRVAC</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">MPI-AMRVAC
   &#160;<span id="projectnumber">3.1</span>
   </div>
   <div id="projectbrief">The MPI - Adaptive Mesh Refinement - Versatile Advection Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Adding a physics module to MPI-AMRVAC </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document explains how you can add a new physics module to MPI-AMRVAC.</p>
<h1>Where to place files, and which makefiles to edit</h1>
<p>MPI-AMRVAC is organized in a library, which in essence only differs according to the dimensionality of the problem: the library part of the code will be compiled in the </p><pre class="fragment">$AMRVAC_DIR/lib/2d_default
</pre><p> directory, if you indicated the setup to be 2D, and used the default architecture settings, i.e. when your problem used <code>$AMRVAC_DIR/setup.pl -d=2</code>. What is contained in this library version is controlled by the makefile called </p><pre class="fragment">$AMRVAC_DIR/arch/lib.make
</pre><p> and this file controls which physics modules are contained in the library. To add a new physics module called 'myphys', add myphys to the line <code>SRC_DIRS := ...</code>: </p><pre class="fragment">SRC_DIRS := . modules amrvacio physics rho hd mhd particle nonlinear myphys
</pre><p> The files for your physics module should then be placed in a newly created subdirectory </p><pre class="fragment">$AMRVAC_DIR/src/myphys
</pre><p> You can put all the required routines in a single file called <code>mod_myphys.t</code>, or use multiple files, for example like this:</p>
<ol type="1">
<li><code>mod_myphys.t</code>: Top level module, which will include the other modules of 'myphys'</li>
<li><code>mod_myphys_phys.t</code>: Contains the basic data and routines for your physics (which variables are required, how to compute fluxes, etc.)</li>
<li><code>mod_myphys_roe.t</code>: Contains methods for the Roe solver</li>
<li><code>makefile</code>: A makefile which lists the relevant source files</li>
</ol>
<p>It is probably best to look at existing physics modules to see which routines are required. The <code>makefile</code> will specify which extra Fortran files the subdirectory contains, and hence would read </p><pre class="fragment">FOBJECTS += mod_myphys_phys.t mod_myphys.t mod_myphys_roe.t
</pre><p> It is important to correspondingly update the module dependencies in the makefile found at </p><pre class="fragment">$AMRVAC_DIR/src/makefile
</pre><p> You can either do this by hand, but a typo-proof manner to do so is to run the script </p><pre class="fragment">$AMRVAC_DIR/src/list_module_deps.sh
</pre><p> This produces a dependency list, which is intended to replace the part in </p><pre class="fragment">$AMRVAC_DIR/src/makefile
</pre><p> which follows the line mentioning </p><pre class="fragment">Dependencies of FOBJECTS (generated by list_module_deps.sh)
</pre><p> Hence, you first edit the <code>$AMRVAC_DIR/src/makefile</code>, delete all lines below this line, and then execute in <code>$AMRVAC_DIR/src</code> the command </p><pre class="fragment">list_module_deps.sh &gt;&gt; makefile
</pre><p> Note: the actual makefile you use for a specific application is in general composed of parts collected from</p>
<ol type="1">
<li><code>$AMRVAC_DIR/src/makefile</code></li>
<li><code>$AMRVAC_DIR/arch/amrvac.make</code></li>
<li><code>$AMRVAC_DIR/arch/lib.make</code></li>
<li><code>$AMRVAC_DIR/arch/default.defs</code> [overruled by $AMRVAC_DIR/setup.pl -arch=debug which uses debug.defs instead]</li>
<li><code>$AMRVAC_DIR/arch/rules.make</code></li>
</ol>
<h1>Physics module bare essentials</h1>
<p>The file </p><pre class="fragment">$AMRVAC_DIR/src/myphys/mod_myphys.t
</pre><p> must specify the way to activate your physics module. At the very least, it will tell the code to use the corresponding </p><pre class="fragment">$AMRVAC_DIR/src/myphys/mod_myphys_phys.t
</pre><p> which contains info on initialization of the variables, controls the addition of new parameters and corresponding entries in the namelists. This is done by <code>subroutine myphys_phys_init()</code>.</p>
<p>Furthermore, <code>mod_myphys_phys.t</code> provides all info on fluxes, (geometric) source terms, etc. See especially the examples provided by </p><pre class="fragment">$AMRVAC_DIR/src/rho/mod_rho.t
$AMRVAC_DIR/src/nonlinear/mod_nonlinear.t
$AMRVAC_DIR/src/hd/mod_hd.t
$AMRVAC_DIR/src/mhd/mod_mhd.t
</pre> <h1>Adding scheme-specific info, source terms, etc</h1>
<p>It is possible to use basic schemes like TVDLF or HLL as soon as the </p><pre class="fragment">$AMRVAC_DIR/src/myphys/mod_myphys_phys.t
</pre><p> contains the corresponding subroutines to identify the maximal and minimal characteristic wave speeds, the fluxes, and the (geometric) source terms. You are also required to specify the way to convert conservative to primitive variables, and back [if relevant for your module]. It is imperative that you use the LASY syntax to ensure that your physics module can be compiled meaningfully in any dimensionality.</p>
<p>Schemes like HLLC, Roe, etc, which require more info on the characteristic decomposition can be added as well, following the examples provided for rho, hd, mhd modules. The same is true for source terms. The roe solver needs to be organized in the file </p><pre class="fragment">$AMRVAC_DIR/src/myphys/mod_myphys_roe.t
</pre> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
