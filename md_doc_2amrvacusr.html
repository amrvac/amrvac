<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MPI-AMRVAC: Setting up a new problem</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js", "TeX/AMSsymbols.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="my_customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">MPI-AMRVAC<span id="projectnumber">&#160;3.1</span>
   </div>
   <div id="projectbrief">The MPI - Adaptive Mesh Refinement - Versatile Advection Code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Setting up a new problem</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="user_intro"></a>
Introduction</h1>
<p>This document describes how users can create new problems. It explains how to set initial conditions, and how to perform other customizations.</p>
<h1><a class="anchor" id="user_setup"></a>
Creating a New Setup</h1>
<p>User code for a new problem should go into a file called either:</p>
<ul>
<li><code>mod_usr.t</code>, if it contains dimension-independent code (Fortran+LASY)</li>
<li><code>mod_usr.f</code>, if it contains regular Fortran code</li>
</ul>
<p>A template for this file is available in <code><a class="el" href="mod__usr__template_8t.html">src/mod_usr_template.t</a></code>. To create a new 1D/2D/3D setup, run one of these commands: </p><pre class="fragment">setup.pl -d=1
setup.pl -d=2
setup.pl -d=3
</pre><p> For 1D problems, you can choose 2 or 3 components for velocity and magnetic field vectors by adding -v flag like setup.pl -d=1 -v=2 or setup.pl -d=1 -v=3. For 2D problems, you can choose 3 components for velocity and magnetic field vectors by adding -v flag like setup.pl -d=2 -v=3.</p>
<p>This setup will copy an AMRVAC makefile and specify the problem dimension and vector components in it. If no user code is found, it will ask whether you want to copy the default template. Alternatively, you can look for an existing problem (look in <code>tests/</code>) and customize its <code>mod_usr.t</code> file to get started. To create a normal Fortran file from <code>mod_usr.t</code>, you can type <code>make mod_usr.f</code>. Specify other user routines, for a list see <code><a class="el" href="mod__usr__methods_8t.html">src/mod_usr_methods.t</a></code> WARNING: If you have compiled your code in n dimension, e.g., -d=3, and want switch to another dimension with the same mod_usr.t file, e.g., -d=2, You need to remove the mod_usr.f file before make to compile because the mod_usr.f will not be updated if mod_usr.t is not changed or touched and it will remain in the n-dimension form.</p>
<h1><a class="anchor" id="user_structure"></a>
Structure of mod_usr.t</h1>
<div class="fragment"><div class="line"><span class="comment">!&gt; This is a template for a new user problem of mhd</span></div>
<div class="line"><span class="keyword">module</span> <a class="code hl_namespace" href="namespacemod__usr.html">mod_usr</a></div>
<div class="line"> </div>
<div class="line">  <span class="comment">! Include a physics module: mod_rho, mod_hd, mod_mhd ...</span></div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacemod__mhd.html">mod_mhd</a></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">implicit none</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">! Custom global variables can be defined here</span></div>
<div class="line">  <span class="comment">! ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">contains</span></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  !&gt; This routine should set user methods, and activate the physics module</span></div>
<div class="line">  <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemod__usr.html#ae9af24eaf30f13b1f264cc800272798c">usr_init</a>()</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Choose coordinate system as 2D Cartesian with three components for vectors</span></div>
<div class="line">    <span class="keyword">call </span>set_coordinate_system(<span class="stringliteral">&quot;Cartesian_2.5D&quot;</span>)</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! A routine for initial conditions is always required</span></div>
<div class="line">    usr_init_one_grid =&gt; <a class="code hl_function" href="namespacemod__usr.html#a38e7d581ffa346854aa22820db4eb13c">initial_conditions</a></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Specify other user routines, for a list see src/mod_usr_methods.t</span></div>
<div class="line">    <span class="comment">! ...</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Choose independent normalization units if using dimensionless variables.</span></div>
<div class="line">    unit_length        = 1.d9 <span class="comment">! cm</span></div>
<div class="line">    unit_temperature   = 1.d6 <span class="comment">! K</span></div>
<div class="line">    unit_numberdensity = 1.d9 <span class="comment">! cm^-3</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Active the physics module: rho_activate(), hd_activate(), mhd_activate()</span></div>
<div class="line">    <span class="keyword">call </span><a class="code hl_function" href="namespacemod__mhd.html#a7a866250156ff45efd487369fe6e21d0">mhd_activate</a>()</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemod__usr.html#ae9af24eaf30f13b1f264cc800272798c">usr_init</a></div>
<div class="line"><span class="comment"></span> </div>
<div class="line"><span class="comment">  !&gt; A routine for specifying initial conditions</span></div>
<div class="line">  <span class="keyword">subroutine </span><a class="code hl_function" href="namespacemod__usr.html#a38e7d581ffa346854aa22820db4eb13c">initial_conditions</a>(ixI^L, ixO^L, w, x)</div>
<div class="line"> </div>
<div class="line">    <span class="keywordtype">integer</span>, <span class="keywordtype">intent(in)</span>             :: ixI^L, ixO^L</div>
<div class="line">    <span class="keywordtype">double precision</span>, <span class="keywordtype">intent(in)</span>    :: x(ixI^S,1:ndim)</div>
<div class="line">    <span class="keywordtype">double precision</span>, <span class="keywordtype">intent(inout)</span> :: w(ixI^S,1:nw)</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! index for do loop and cell faces</span></div>
<div class="line">    <span class="keywordtype">integer</span> :: idir, ixC^L</div>
<div class="line"> </div>
<div class="line">    <span class="comment">! Set initial values for w</span></div>
<div class="line">    <span class="comment">! 1.d0 and 0.d0 are just examples should be adjusted to user&#39;s problem</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! cell-center density</span></div>
<div class="line">    w(ixo^s, rho_) = 1.d0</div>
<div class="line">    <span class="comment">! cell-center velocity </span></div>
<div class="line">    w(ixo^s, mom(1)) = 0.d0</div>
<div class="line">    w(ixo^s, mom(2)) = 0.d0</div>
<div class="line">    <span class="comment">! cell-center pressure</span></div>
<div class="line">    w(ixo^s, e_) = 1.d0</div>
<div class="line">    <span class="keywordflow">if</span>(stagger_grid) <span class="keywordflow">then</span></div>
<div class="line">      <span class="comment">! set cell-face magnetic field B using CT method for divB control</span></div>
<div class="line"> </div>
<div class="line">      <span class="comment">! set B from vector potential (zero divB guaranteed) given </span></div>
<div class="line">      <span class="comment">! usr_init_vector_potential pointing to  a subroutine to set vector potential</span></div>
<div class="line">      <span class="keyword">call </span>b_from_vector_potential(ixgs^ll,ixi^l,ixo^l,block%ws,x)</div>
<div class="line"> </div>
<div class="line">      <span class="comment">! or directly set cell-face B (divB maybe non-zero) as following:</span></div>
<div class="line">      <span class="keywordflow">do</span> idir=1,ndim</div>
<div class="line">        ixcmin^d=iximin^d;</div>
<div class="line">        ixcmax^d=iximax^d-kr(idir,^d);</div>
<div class="line">        <span class="comment">! cell-face B_idir</span></div>
<div class="line">        block%ws(ixc^s,idir)=1.d0</div>
<div class="line"><span class="keywordflow">      end do</span></div>
<div class="line">      <span class="comment">! update cell-center B from cell-face B</span></div>
<div class="line">      <span class="keyword">call </span>mhd_face_to_center(ixo^l,block)</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">      <span class="comment">! cell-center magnetic field</span></div>
<div class="line">      w(ixo^s,mag(1)) = 1.d0</div>
<div class="line">      w(ixo^s,mag(2)) = 1.d0</div>
<div class="line"><span class="keywordflow">    end if</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">! convert primitive variables to conservative variables</span></div>
<div class="line">    <span class="keyword">call </span>mhd_to_conserved(ixi^l,ixo^l,w,x)</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">end subroutine </span><a class="code hl_function" href="namespacemod__usr.html#a38e7d581ffa346854aa22820db4eb13c">initial_conditions</a></div>
<div class="line"> </div>
<div class="line">  <span class="comment">! Extra routines can be placed here</span></div>
<div class="line">  <span class="comment">! ...</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">end module </span><a class="code hl_namespace" href="namespacemod__usr.html">mod_usr</a></div>
<div class="ttc" id="anamespacemod__mhd_html"><div class="ttname"><a href="namespacemod__mhd.html">mod_mhd</a></div><div class="ttdef"><b>Definition</b> <a href="mod__mhd_8t_source.html#l00001">mod_mhd.t:1</a></div></div>
<div class="ttc" id="anamespacemod__mhd_html_a7a866250156ff45efd487369fe6e21d0"><div class="ttname"><a href="namespacemod__mhd.html#a7a866250156ff45efd487369fe6e21d0">mod_mhd::mhd_activate</a></div><div class="ttdeci">subroutine mhd_activate()</div><div class="ttdef"><b>Definition</b> <a href="mod__mhd_8t_source.html#l00014">mod_mhd.t:15</a></div></div>
<div class="ttc" id="anamespacemod__usr_html"><div class="ttname"><a href="namespacemod__usr.html">mod_usr</a></div><div class="ttdoc">This is a template for a new user problem of mhd.</div><div class="ttdef"><b>Definition</b> <a href="mod__usr__template_8t_source.html#l00002">mod_usr_template.t:2</a></div></div>
<div class="ttc" id="anamespacemod__usr_html_a38e7d581ffa346854aa22820db4eb13c"><div class="ttname"><a href="namespacemod__usr.html#a38e7d581ffa346854aa22820db4eb13c">mod_usr::initial_conditions</a></div><div class="ttdeci">subroutine initial_conditions(ixil, ixol, w, x)</div><div class="ttdoc">A routine for specifying initial conditions.</div><div class="ttdef"><b>Definition</b> <a href="mod__usr__template_8t_source.html#l00037">mod_usr_template.t:38</a></div></div>
<div class="ttc" id="anamespacemod__usr_html_ae9af24eaf30f13b1f264cc800272798c"><div class="ttname"><a href="namespacemod__usr.html#ae9af24eaf30f13b1f264cc800272798c">mod_usr::usr_init</a></div><div class="ttdeci">subroutine usr_init()</div><div class="ttdoc">This routine should set user methods, and activate the physics module.</div><div class="ttdef"><b>Definition</b> <a href="mod__usr__template_8t_source.html#l00015">mod_usr_template.t:16</a></div></div>
</div><!-- fragment --><p>In the call set_coordinate_system, the argument "Cartesian_2.5D" means using 2-dimension 3-vector-component Cartesian coordinates. "Cartesian_1.5D" means 1-dimension 2-vector-component Cartesian, and "Cartesian_1.75D" means 1-dimension 3-vector-component Cartesian. If "Cartesian_1D", 1-dimension 1-vector-component Cartesian. <br  />
 If "Cartesian_2D", 2-dimension 2-vector-component Cartesian. <br  />
 If "Cartesian_3D", 3-dimension 3-vector-component Cartesian. <br  />
 If number of vector components is larger than dimension number, -v flag should be set consistently during setup.</p>
<h2><a class="anchor" id="user_specialbound"></a>
Special boundary</h2>
<p>When the predefined boundary types provided by MPI-AMRVAC are not sufficient , a pointed <b>usr_special_bc</b> subroutine can solve the problem. It is called for each boundary region and all variable in the boundary region <b>typeboundary_min1=8*'special'...</b> is selected.</p>
<h2><a class="anchor" id="user_specialsource"></a>
Special source</h2>
<p>There are lots of possible physical source terms for the same basic equation. Rather than writing a new physics module for each, it is simpler to define a problem dependent source term in the user module.</p>
<p>A pointed <b>usr_source</b> subroutine will be called at least once in every time step. The number of calls depends on the time integration scheme defined by <b>time_integrator</b>, the parameter <b>source_split_usr</b> and also on the number of dimensions if the parameter <b>dimsplit=T</b>.</p>
<p>In any case the subroutine should integrate <b>w</b> from time <b>qt</b> to <b>qt+qdt</b> for the variables listed in <b>iw^LIM</b> in the region <b>ixO^S</b>. The source terms should be evaluated for the <b>wCT</b> array, which corresponds to the physical time <b>qtC</b>. In case of explicit time dependence, <b>qtC</b> should be used as time. Only elements within <b>ixI^S</b> can be used from <b>wCT</b>.</p>
<p>A pointed <b>usr_get_dt</b> subroutine can limit <b>dt</b> for numerical stability if the source term requires that.</p>
<p>A pointed <b>usr_special_resistivity</b> subroutine is used for MHD to set the resistivity array <b>eta</b> when it is not constant in time and/or space.</p>
<p>A pointed <b>usr_refine_grid</b> subroutine allows to add user controlled (de)refinement, by setting the integers <em>refine,coarsen</em>. You have all info available to do this refining (grid level, physical values in <em>w</em>, coordinates in <em>x</em>, time in <em>qt</em>). Similarly, a <b>usr_var_for_errest</b> subroutine allows to compute a (local) new variable, to be stored in <em>var</em>, on which you can then base refinement as well.</p>
<h2><a class="anchor" id="user_speciallog"></a>
Special output and analysis</h2>
<p>The default log-file may be altered, for which you need to code up <br  />
 a <b>usr_print_log</b> subroutine. For parallel execution, this invariably means the use of MPI constructs, so you should copy in the default version <b>printlog_default</b> from <em>src/amrvacio/mod_input_output.t</em> and then study it, and modify accordingly. An example of this customization is given in <em>tests/rho/custom_log_file</em>.</p>
<p>A pointed <b>usr_aux_output</b> is extremely handy to compute variables from the actually computed conserved variables, that can then be visualized directly. It is only used in combination with the conversion subroutines. e.g., one may here compute current density components using the actual code discretizations for computing a curl, and then visualize those with any of the visualization tools applicable. You then also need to specify a name for each variable, in a pointed <b>usr_add_aux_names</b>.</p>
<p>A pointed <b>usr_process_grid</b> and a pointed <b>usr_process_global</b> are subroutines called in each iteration, which allow to compute auxiliary variables which happen to be non-local (like div v), and are in no way used for flux computations. As auxiliaries, they are also not advanced. This functionality was added to allow e.g. for separate particle treatments using stochastic differential equations, where the particle dynamics is only relying on local compression values. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
